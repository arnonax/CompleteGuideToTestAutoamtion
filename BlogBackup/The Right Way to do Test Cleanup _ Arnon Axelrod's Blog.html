<!DOCTYPE html>
<!-- saved from url=(0070)http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/ -->
<html lang="en-US"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="initial-scale=1.0, width=device-width">
<title>The Right Way to do Test Cleanup | Arnon Axelrod's Blog</title>
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="http://blogs.microsoft.co.il/arnona/xmlrpc.php">


<!--[if lt IE 9]>
           <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
           <script>window.html5 || document.write('<script src="http://blogs.microsoft.co.il/arnona/wp-content/themes/MS_englishjs/vendor/html5shiv.js"><\/script>')</script>
    <![endif]-->
			 
 <script src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/track.js.download"></script><script src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/all.js.download" async="" crossorigin="anonymous"></script><script id="twitter-wjs" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/widgets.js.download"></script><script id="facebook-jssdk" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/all.js(1).download"></script><script src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/jquery.min.js.download"></script>
 <script src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/app.js.download"></script>
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Arnon Axelrod&#39;s Blog » Feed" href="http://blogs.microsoft.co.il/arnona/feed/">
<link rel="alternate" type="application/rss+xml" title="Arnon Axelrod&#39;s Blog » Comments Feed" href="http://blogs.microsoft.co.il/arnona/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Arnon Axelrod&#39;s Blog » The Right Way to do Test Cleanup Comments Feed" href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/feed/">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/blogs.microsoft.co.il\/arnona\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.0.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/wp-emoji-release.min.js.download" type="text/javascript" defer=""></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="wp-block-library-css" href="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="microsoft-hebrew-normalize-css" href="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/normalize.css" type="text/css" media="all">
<link rel="stylesheet" id="MS_english-style-css" href="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="ms_global_search_css_style-css" href="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/style(1).css" type="text/css" media="all">
<link rel="https://api.w.org/" href="http://blogs.microsoft.co.il/arnona/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://blogs.microsoft.co.il/arnona/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://blogs.microsoft.co.il/arnona/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="TDD, SOLID, Functional Programming, Declarative programming and more…" href="http://blogs.microsoft.co.il/arnona/2013/12/19/tdd-solid-functional-programming-declarative-programming/">
<link rel="next" title="Refactoring towards the Liskov Substitution Principle" href="http://blogs.microsoft.co.il/arnona/2015/01/04/refactoring-toward-liskov-substitution-principle/">
<meta name="generator" content="WordPress 5.0.2">
<link rel="canonical" href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/">
<link rel="shortlink" href="http://blogs.microsoft.co.il/arnona/?p=2085734">
<link rel="alternate" type="application/json+oembed" href="http://blogs.microsoft.co.il/arnona/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fblogs.microsoft.co.il%2Farnona%2F2014%2F09%2F02%2Fright-way-test-cleanup%2F">
<link rel="alternate" type="text/xml+oembed" href="http://blogs.microsoft.co.il/arnona/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fblogs.microsoft.co.il%2Farnona%2F2014%2F09%2F02%2Fright-way-test-cleanup%2F&amp;format=xml">

<!-- ADD TO HEADER - START -->

<!-- ADD TO HEADER - END -->
		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
		<link rel="stylesheet" type="text/css" href="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/shCore.css"><link rel="stylesheet" type="text/css" href="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/shThemeDefault.css"><style type="text/css" id="syntaxhighlighteranchor"></style>
<meta data-pso-pv="1.2.1" data-pso-pt="singlePost" data-pso-th="91ad9b44edb2998a2b2273710387f6a2">
<!--Wise pixel Microsoft Blogs-->
<script language="JavaScript1.1" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/js"></script><iframe src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/iframe.html" id="mm_sync_back_ground" style="visibility: hidden; display: none;"></iframe>

<style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_reposition{overflow:hidden;position:relative}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:right;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}@keyframes fb_transform{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.fb_animate{animation:fb_transform .3s forwards}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_dialog_advanced{border-radius:8px;padding:10px}.fb_dialog_content{background:#fff;color:#373737}.fb_dialog_close_icon{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;cursor:pointer;display:block;height:15px;position:absolute;left:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{right:5px;left:auto;top:5px}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent}.fb_dialog_close_icon:active{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #365899;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:right;padding:5px 26px 7px 0}body.fb_hidden{height:100%;right:0;margin:0;overflow:visible;position:absolute;top:-10000px;transform:none;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{background:none;height:auto;min-height:initial;min-width:initial;width:auto}.fb_dialog.fb_dialog_mobile.loading.centered #fb_dialog_loader_spinner{width:100%}.fb_dialog.fb_dialog_mobile.loading.centered .fb_dialog_content{background:none}.loading.centered #fb_dialog_loader_close{clear:both;color:#fff;display:block;font-size:18px;padding-top:20px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .4);bottom:0;right:0;min-height:100%;position:absolute;left:0;top:0;width:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_mobile .fb_dialog_iframe{position:sticky;top:0}.fb_dialog_content .dialog_header{background:linear-gradient(from(#738aba), to(#2c4987));border-bottom:1px solid;border-color:#043b87;box-shadow:white 0 1px 1px -1px inset;color:#fff;font:bold 14px Helvetica, sans-serif;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:linear-gradient(from(#4267B2), to(#2a4887));background-clip:padding-box;border:1px solid #29487d;border-radius:3px;display:inline-block;line-height:18px;margin-top:3px;max-width:85px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{background:none;border:none;color:#fff;font:bold 12px Helvetica, sans-serif;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(https://static.xx.fbcdn.net/rsrc.php/v3/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #4a4a4a;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f5f6f7;border:1px solid #4a4a4a;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:right}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}#fb_dialog_loader_spinner{animation:rotateSpinner 1.2s linear infinite;background-color:transparent;background-image:url(https://static.xx.fbcdn.net/rsrc.php/v3/yD/r/t-wz8gw1xG1.png);background-position:50% 50%;background-repeat:no-repeat;height:24px;width:24px}@keyframes rotateSpinner{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_fluid_desktop,.fb_iframe_widget_fluid_desktop span,.fb_iframe_widget_fluid_desktop iframe{max-width:100%}.fb_iframe_widget_fluid_desktop iframe{min-width:220px;position:relative}.fb_iframe_widget_lift{z-index:1}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}</style></head>
<body class="post-template-default single single-post postid-2085734 single-format-standard single-author " style="">
<div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; width: 0px; height: 0px;"><div><iframe name="fb_xdm_frame_https" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" frameborder="0" allowtransparency="true" allowfullscreen="true" scrolling="no" allow="encrypted-media" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/xd_arbiter.html" style="border: none;"></iframe></div><div></div></div></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/he_IL/all.js#xfbml=1&appId=171021386433126";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
	

<div id="top-bar" class="wrapper clearfix">
        <a href="http://blogs.microsoft.co.il/" id="blogs-logo" class="ir">Israel Blogging Community</a>
        <div id="user-options">
                            
            <a href="http://blogs.microsoft.co.il/arnona/wp-admin">Sign in</a>
                      </div>
</div>
  <header>
      
		
        <div id="header-banner" style="background-image: url(http://blogs.microsoft.co.il/arnona/wp-content/uploads/sites/1346/2015/01/cropped-04621.jpg)">
            <div class="wrapper">
                <h1 id="blog-title">
                     
                    <span class="sub-title">Arnon Axelrod's Blog</span>
                </h1>
                            </div>
        </div>
        <div id="header-nav" class="clearfix">
            <div class="wrapper">
                <div id="user-avatar">
                    <img src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/d3548b43b3f07144c336ab8378da3ecd.jpeg" alt="">
                </div>
                <div id="header-nav-box">
                    <a href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/#" class="ir" id="m-nav">menu</a>
                    <nav id="heder-nav-warpper">
                        <a href="http://blogs.microsoft.co.il/arnona">Home page</a>

                                        </nav>
                    <div id="header-nav-icons">
                                                                        <a href="https://www.linkedin.com/in/arnonaxelrod" target="_blank" class="ir icon-in">linkedin</a>
                                                <a href="http://blogs.microsoft.co.il/arnona/rss2" target="_blank" class="ir icon-rss">RSS</a>
                    </div>
                </div>
                <script>
                    (function (window) {
                        if (!document.addEventListener)
                            return;

                        var navBtn = document.getElementById("m-nav");
                        var nav = document.getElementById("heder-nav-warpper");

                        navBtn.addEventListener('click', function (e) {
                            e.preventDefault();
                            var display = window.getComputedStyle(nav, null).getPropertyValue("display");
                            if (display === 'none')
                                nav.style.display = 'block';
                            else
                                nav.style.display = 'none';

                        }, false);

                        window.addEventListener('resize', function () {
                            nav.style.display = "";
                        }, false);

                    })(window);
                </script>
            </div>
        </div>

    </header>
<!-- #masthead -->
 <div id="main" role="main" class="clearfix">
	<div id="primary_blog" class="wrapper clearfix">
        <section id="blog_post_info">			
			<script>
jQuery(document).ready(function(){
jQuery('.bp-add-comment').click(function(event){
event.preventDefault();
jQuery('#respond').show();
});
});
</script>
	<article id="post-2085734" class="bp clearfix post-2085734 post type-post status-publish format-standard hentry tag-automated-tests tag-cleanup tag-ms-test tag-unit-tests">
		         
			            <h2 class="bp-title">
                <a href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/">The Right Way to do Test Cleanup</a>
            </h2>
            <h3 class="bp-date">September 2, 2014</h3>
            <div class="clearfix">
            <div class="bp-thumb clearfix">
                                                <div class="bp-social_i">
                            <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/" class="ir icon-fb">facebook</a>
                            <a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/&amp;title=The%20Right%20Way%20to%20do%20Test%20Cleanup&amp;summary=%3Cp%3EMSTest%20and%20NUnit,%20as%20most%20of%20the%20other%20common%20test%20frameworks,%20provide%20means%20for%20write%20cleanup%20code%20that%20is%20executed%20whether%20the%20test%20passed%20or%20failed.%20In%20addition%20they%20provide%20means%20to%20write%20cleanup%20code%20that%20runs%20after%20all%20tests%20in%20a%20class%20or%20assembly%20has%20completed.%20This%20is%20especially%20important%20in%20End-to-end%20or%20Integration%20[%E2%80%A6]%3C/p%3E" class="ir icon-in">linkedin</a>
                            <a target="_blank" href="https://twitter.com/share" class="tweet ir icon-twitter" data-lang="he">twitter</a>
                            <a href="mailto:?subject=The%20Right%20Way%20to%20do%20Test%20Cleanup&amp;body=Check%20out%20this%20post%20http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/" class="ir icon-email">email</a>
                        </div>
              </div>
             </div>
	
				<div class="clearfix">
			        <div class="tagsx">tags:   <a href="http://blogs.microsoft.co.il/arnona/tag/automated-tests/" rel="tag">Automated tests</a>, <a href="http://blogs.microsoft.co.il/arnona/tag/cleanup/" rel="tag">Cleanup</a>, <a href="http://blogs.microsoft.co.il/arnona/tag/ms-test/" rel="tag">MS-Test</a>, <a href="http://blogs.microsoft.co.il/arnona/tag/unit-tests/" rel="tag">Unit Tests</a></div>
				    <div class="cmts"> 2 comments </div>
			    </div>
		
						
		<!-- .entry-header -->

				<div class="contx entry-content clearfix">
			<p>MSTest and NUnit, as most of the other common test frameworks, provide means for write cleanup code that is executed whether the test passed or failed. In addition they provide means to write cleanup code that runs after all tests in a class or assembly has completed. This is especially important in End-to-end or Integration Tests, in which the tests cannot be 100% isolated from one another.</p>
<p>In MSTest this is done using the [AssemblyCleanup], [ClassCleanup] and [TestCleanup] attributes. Of course there are also corresponding [*Initialize] attributes, but this is out of the scope of our discussion. Look <a href="http://blogs.msdn.com/b/nnaderi/archive/2007/02/01/mstest-vs-nunit-frameworks.aspx">here</a> for the corresponding NUnit alternatives.</p>
<p>In order to promote isolation, you should rarely use the ClassIntiaiilize/ClassCleanup and AssemblyInitialize/AssemblyCleanup for actions that modify the environment, unless they are very expensive (in matters of time or disk space), so I’ll talk mainly about the use of the Test Cleanup method.</p>
<h3>The problem with the normal [TestCleanup] approach</h3>
<p>From one hand, the fact that the test cleanup happens whether the test passed or failed ensures that the environment does not remain dirty after a failing test. However, <b>it forces you to be extra careful</b> when writing the cleanup method, to ensure that it’s correct in all cases. If you consider that tests may fail in any step in the test (I know, tests should be small, but still…) you’d realize that it’s very hard to write a good, robust cleanup method that always works, and <b>there’s no practical way to <i>test</i> all of these cases at all!</b> Needless to say, if there’s a bug in the test cleanup, then the next tests may fail in vain.</p>
<h3>Avoid [TestInitialize]</h3>
<p>Like any normal initialize/cleanup pattern (also the one which is implemented by the ‘using’ keyword in C#), if there’s an exception in the initialization, then the cleanup is not called. The cleanup code is called either if the body (test) completed successfully or if an exception occurred.</p>
<p>This pattern works fine as long as the operation in the TestInitialize method is transactional. In other words, either it completes successfully or it doesn’t change the environment at all. However, in real-world this is rarely the case, and you would often need to perform several actions in the test initialization, that each may fail or not. If the first action succeeded but the second failed, then the first one should still be reverted, but the second should not. If you’re putting all of your initialization code in the [TestInitialize] method, and an exception occurred in the second action, <b>then the first action won’t be cleaned-up at all!</b> In addition, I see that initialization of the test an integral part of the test itself, and I see no good reason to separate it to a different method in most cases. I also find that in most cases that people use a TestInitiailize method in a Test Class that contains more than 1 test, no test actually needs <i>everything</i> that the TestInitialize does, and it only complicates things and increases the risk of things that can go wrong. I normally tell these people to put just the stuff they need inside the Test Method, and that will make the test more readable and reliable. Of course that when you do that, you should extract common code to a well-named methods.</p>
<h3>So what <i>should</i> be done?</h3>
<p>I’ll describe the full solution step-by-step, in order to explain the need of each nuance of the final solution. So let’s start from the basic solution:</p>
<p>The basic solution is to manage a list of Actions delegates that each does an atomic cleanup operation. Immediately after successfully performing an atomic operation that changes the state of the environment, you need to add a delegate to a method (or lambda) that undoes that operation. In the [TestCleanup] method, loop over the list of delegates and invoke them one by one.</p>
<p>If, for example, the 4<sup>th</sup> operation fails, then the first three will be undone. Let’s take more concrete example:</p>
<p>Suppose we’re building an e-commerce website, and we want to test that when buying 3 items, and adding a coupon gives the appropriate price reduction. In order to test this scenario, we should first add 3 products to the catalog and the coupon details. The test method, <b>without the cleanup code</b>, should look like this:</p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:5ffa0cc4-462e-4baa-8450-75b5736cfaa4" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_172769" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">01</div><div class="line number2 index1 alt1">02</div><div class="line number3 index2 alt2">03</div><div class="line number4 index3 alt1">04</div><div class="line number5 index4 alt2">05</div><div class="line number6 index5 alt1">06</div><div class="line number7 index6 alt2">07</div><div class="line number8 index7 alt1">08</div><div class="line number9 index8 alt2">09</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">[TestMethod]</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">CouponGivesPriceReduction()</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">usbCable = AddProductToCatalog(</code><code class="csharp string">"USB Cable"</code><code class="csharp plain">, price:3);</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">adapter = AddProductToCatalog(</code><code class="csharp string">"Car AC to USB adapter"</code><code class="csharp plain">, price:7);</code></div><div class="line number6 index5 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">phoneHolder = AddProductToCatalog(</code><code class="csharp string">"SmartPhone car holder"</code><code class="csharp plain">, price:20);</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">coupon = DefineCouponDetails(</code><code class="csharp string">"12345"</code><code class="csharp plain">, percentsReduction=20);</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">shoppingCart = CreateShoppingCart();</code></div><div class="line number10 index9 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddItem (usbCable);</code></div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddItem (adapter);</code></div><div class="line number12 index11 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddItem (coupon);</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">totalBeforeCoupon = shoppingCart.GetTotal();</code></div><div class="line number15 index14 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Assert.AreEqual(30, totalBeforeCoupon, </code><code class="csharp string">"Total before coupon added should be 30 (3+7+20)"</code><code class="csharp plain">);</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddCoupon(coupon);</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">const</code> <code class="csharp keyword">decimal</code> <code class="csharp plain">expectedTotalAfterCoupon = totalBeforeCouon * (1 - 20/100); </code><code class="csharp comments">// 20% reduction</code></div><div class="line number20 index19 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">totalAfterCoupon = shoppingCart.GetTotal();</code></div><div class="line number21 index20 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Assert.AreEuqal(expectedTotalAfterCoupon, totalAfterCoupon, </code><code class="csharp string">"Total after coupon"</code><code class="csharp plain">);</code></div><div class="line number22 index21 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>In order to leave the environment clean, we need to delete the products we added to the catalog and the coupon definition. So let’s first define the generic cleanup mechanism:</p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:219c56a7-ad10-4a0e-ae2d-9c779336e262" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_473883" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">01</div><div class="line number2 index1 alt1">02</div><div class="line number3 index2 alt2">03</div><div class="line number4 index3 alt1">04</div><div class="line number5 index4 alt2">05</div><div class="line number6 index5 alt1">06</div><div class="line number7 index6 alt2">07</div><div class="line number8 index7 alt1">08</div><div class="line number9 index8 alt2">09</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp keyword">private</code> <code class="csharp plain">List&lt;Action&gt; _cleanupActions = </code><code class="csharp keyword">new</code> <code class="csharp plain">List&lt;Action&gt;();</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">private</code> <code class="csharp keyword">void</code> <code class="csharp plain">AddCleanupAction(Action cleanupAction)</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_cleanupActions.Add(cleanupAction);</code></div><div class="line number5 index4 alt2"><code class="csharp plain">}</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="csharp plain">[TestCleanup]</code></div><div class="line number8 index7 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">Cleanup()</code></div><div class="line number9 index8 alt2"><code class="csharp plain">{</code></div><div class="line number10 index9 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code><code class="csharp plain">(</code><code class="csharp keyword">var</code> <code class="csharp plain">action </code><code class="csharp keyword">in</code> <code class="csharp plain">_cleanupActions)</code></div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number12 index11 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">action();</code></div><div class="line number13 index12 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number14 index13 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Now, let’s add the appropriate calls to this method:</p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:453474d4-bc9f-4c09-be28-9f9151674f1f" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_505865" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">[TestMethod]</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">CouponGivesPriceReduction()</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">usbCable = AddProductToCatalog(“USB Cable”, price:3);</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">AddCleanupAction(() =&gt; RemoveProductFromCatalog(usbCable));</code></div><div class="line number6 index5 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">adapter = AddProductToCatalog(“Car AC to USB adapter”, price:7);</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">AddCleanupAction(() =&gt; RemoveProductFromCatalog(adapter));</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">phoneHolder = AddProductToCatalog(“SmartPhone car holder”, price:20);</code></div><div class="line number9 index8 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">AddCleanupAction(() =&gt; RemoveProductFromCatalog(phoneHolder));</code></div><div class="line number10 index9 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">coupon = DefineCouponDetails(“12345”, percentsReduction=20);</code></div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">AddCleanupAction(() =&gt; RemoveCouponDefinition(coupon));</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">shoppingCart = CreateShoppingCart();</code></div><div class="line number14 index13 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddItem (usbCable);</code></div><div class="line number15 index14 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddItem (adapter);</code></div><div class="line number16 index15 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddItem (coupon);</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">totalBeforeCoupon = shoppingCart.GetTotal();</code></div><div class="line number19 index18 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Assert.AreEqual(30, totalBeforeCoupon, “Total before coupon added should be 30 (3+7+20)”);</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddCoupon(coupon);</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">const</code> <code class="csharp keyword">decimal</code> <code class="csharp plain">expectedTotalAfterCoupon = totalBeforeCouon * (1 - 20/100); </code><code class="csharp comments">// 20% reduction</code></div><div class="line number24 index23 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">totalAfterCoupon = shoppingCart.GetTotal();</code></div><div class="line number25 index24 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Assert.AreEuqal(expectedTotalAfterCoupon, totalAfterCoupon, “Total after coupon”);</code></div><div class="line number26 index25 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>However, there are 2 problems with this cleanup approach:</p>
<ol>
<li>The test method is now cluttered with plumbing code</li>
<li>Whenever we’ll want to call AddProductToCatalog or DefineCouponDetails, we need to remember to add the appropriate cleanup action! This is very error-prone…</li>
</ol>
<p>Gladly, the solution to both of these problems is very easy: Just move the appropriate call to AddCleanupAction inside to AddProductToCatalog and DefineCouponDetails. For example:</p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:f7fb7ac3-f519-4e08-9939-76ab8dcae539" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_491262" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp keyword">private</code> <code class="csharp plain">Product AddProductToCatalog(</code><code class="csharp keyword">string</code> <code class="csharp plain">name, </code><code class="csharp keyword">decimal</code> <code class="csharp plain">price)</code></div><div class="line number2 index1 alt1"><code class="csharp plain">{</code></div><div class="line number3 index2 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">product = … </code><code class="csharp comments">// original code of AddProductToCatalog comes here (e.g. send HTTP request or add the data directly to the database, as appropriate, and returning a new instance of an object that represents the new product)</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">AddCleanupAction(() =&gt; RemoveProductFromCatalog(product);</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">return</code> <code class="csharp plain">product;</code></div><div class="line number8 index7 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3>Reusability</h3>
<p>Because we’re probably need this mechanism in most or even all of our test classes, it makes sense to extract this behavior to a common base class:</p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:f7fb7ac3-f519-4e08-9939-76ab8dcae539" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_159976" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">[TestClass]</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">abstract</code> <code class="csharp keyword">class</code> <code class="csharp plain">TestBase</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">private</code> <code class="csharp plain">List&lt;Action&gt; _cleanupActions = </code><code class="csharp keyword">new</code> <code class="csharp plain">List&lt;Action&gt;();</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">AddCleanupAction(Action cleanupAction)</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_cleanupActions.Add(cleanupAction);</code></div><div class="line number9 index8 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">[TestCleanup]</code></div><div class="line number12 index11 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">Cleanup()</code></div><div class="line number13 index12 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number14 index13 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code><code class="csharp plain">(</code><code class="csharp keyword">var</code> <code class="csharp plain">action </code><code class="csharp keyword">in</code> <code class="csharp plain">_cleanupActions)</code></div><div class="line number15 index14 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number16 index15 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">action();</code></div><div class="line number17 index16 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number18 index17 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number19 index18 alt2"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3>What about dependencies?</h3>
<p>That’s all nice and fine, as long as the changes we’re doing to the environment are independent from one another. Let’s modify our example a little: suppose we want to support a different type of coupon, one that is associated with a specific product, and grants a discount if only that particular product is purchased <i>n</i> times. In this scenario, the Coupon Definition must refer to a particular product, and therefore the Product must be created first, and only then the Coupon definition. If the application’s enforces referential integrity between the Coupon Definition and the Product, then it should throw an error if you would try to delete the Product before the Coupon Definition.</p>
<p>The following test code would throw an error in the Cleanup method, saying that “Procuct ‘USB Cable’ can’t be deleted because there are active Coupon definitions associated with it”:</p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:5f449771-a9bf-4950-9239-d08770bfcd01" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_898421" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">[TestMethod]</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">CouponGivesPriceReduction()</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">usbCable = AddProductToCatalog(“USB Cable”, price:3);</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">coupon = DefineCouponDetailsForProduct(“12345”, usbCable, minimumCount:4, percentsReduction=20);</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">shoppingCart = CreateShoppingCart();</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddItem (usbCable, count:4);</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">totalBeforeCoupon = shoppingCart.GetTotal();</code></div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Assert.AreEqual(3 * 4, totalBeforeCoupon, “Total before coupon added should be 30 (3+7+20)”);</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">shoppingCart.AddCoupon(coupon);</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">const</code> <code class="csharp keyword">decimal</code> <code class="csharp plain">expectedTotalAfterCoupon = totalBeforeCouon * (1 - 20/100); </code><code class="csharp comments">// 20% reduction</code></div><div class="line number16 index15 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">totalAfterCoupon = shoppingCart.GetTotal();</code></div><div class="line number17 index16 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Assert.AreEuqal(expectedTotalAfterCoupon, totalAfterCoupon, “Total after coupon”);</code></div><div class="line number18 index17 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Fortunately, the solution to this is also pretty simple: simply <b>call the cleanup methods in the reverse order to which they were added</b>. The na?ve implementation would look like this:<b></b></p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:21e5babd-5ba0-41d5-92f2-a771d2532968" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_159646" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">[TestCleanup]</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">Cleanup()</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_cleanupActions.Reverse();</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code><code class="csharp plain">(</code><code class="csharp keyword">var</code> <code class="csharp plain">action </code><code class="csharp keyword">in</code> <code class="csharp plain">_cleanupActions)</code></div><div class="line number6 index5 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">action();</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number9 index8 alt2"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>Now the cleanup will be done in the right order, and no exception will occur.</p>
<p>Note: obviously, using a Stack object instead of List will be most efficient, but in my experience this is negligible, as this list has normally very few elements.</p>
<h3>How to handle exceptions in cleanup?</h3>
<p>But what happens if one of the cleanup actions fails?! Unfortunately, nothing can be 100% safe and if actions are dependent on one another like in the previous example, then if the first executed (which is the last entered) cleanup action failed, then we can be pretty sure that the second one will fail too. But if there are actions that are not inter-dependent, then it’s still worthwhile trying to call them too! However that means that there’s a chance that multiple exceptions will occur during the cleanup process. So we need to collect all of them and then throw a new AggregateException, containing all of them.</p>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:183e2b05-1cc6-412d-bc78-8d6848fb7b92" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_370915" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">[TestCleanup]</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">Cleanup()</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_cleanupActions.Reverse();</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">exceptions = </code><code class="csharp keyword">new</code> <code class="csharp plain">List&lt;Exception&gt;();</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code> <code class="csharp plain">(</code><code class="csharp keyword">var</code> <code class="csharp plain">action </code><code class="csharp keyword">in</code> <code class="csharp plain">_cleanupActions)</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number9 index8 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">try</code></div><div class="line number10 index9 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">action();</code></div><div class="line number12 index11 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number13 index12 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">catch</code><code class="csharp plain">(Exception ex)</code></div><div class="line number14 index13 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number15 index14 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">exceptions.Add(ex);</code></div><div class="line number16 index15 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number17 index16 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">if</code> <code class="csharp plain">(exceptions.Count == 1)</code></div><div class="line number20 index19 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">throw</code> <code class="csharp plain">exceptions.Single();</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">if</code> <code class="csharp plain">(exceptions.Count &gt; 1)</code></div><div class="line number23 index22 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">throw</code> <code class="csharp keyword">new</code> <code class="csharp plain">AggregateException(</code><code class="csharp string">"Multiple exceptions occurred in Cleanup."</code><code class="csharp plain">, exceptions);</code></div><div class="line number24 index23 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3>Use [TestInitiailize] anyway…</h3>
<p>Even though TestInitialize is mostly discouraged, there are cases where it helps to remove duplication and, in a sense, “hide” some of the preparation code. In order to allow this, but still take care of proper cleanup, you can define the [TestInitialize] method in the base class, and call a virtual method that can be overridden in the test class, from within a try/catch block. In the catch block, we’ll call the cleanup actions. See the final solution later on.</p>
<h3>Few More Gems</h3>
<p>There are few more little things in the final solution that worth noting:</p>
<ol>
<li>If your test code (including Initialization code) writes stuff to the test’s standard output, then it makes it very convenient to add a clear separator between what’s written from the Initilaize method, what’s written from the test’s body, and what’s written from the cleanup. That’s what the Console.WriteLine lines in the TestInitialize and TestCleanup methods are for.</li>
<li>In order to prevent users of the base class from using [TestInitialize] and [TestCleanup] on their own methods directly (and circumvent our robust cleanup mechanism), we define our own TestInitializeAttribute and TestCleanupAttribute classes. Frankly if the user insists, she can specify the full name of the original attributes. But at least she’ll know that it’s not the recommended way.</li>
</ol>
<h3>The Final Solution</h3>
<div class="wlWriterEditableSmartContent" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:42ea7eff-3baf-4b0b-bd85-c8e27b8e845a" style="float: none;margin: 0px;padding: 0px">
<div><div id="highlighter_622007" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">[TestClass]</code></div><div class="line number2 index1 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">abstract</code> <code class="csharp keyword">class</code> <code class="csharp plain">TestBase</code></div><div class="line number3 index2 alt2"><code class="csharp plain">{</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">[Obsolete(</code><code class="csharp string">"Override the Initialize method instead of using [TestIniatialize]"</code><code class="csharp plain">, </code><code class="csharp keyword">true</code><code class="csharp plain">)]</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">class</code> <code class="csharp plain">TestInitializeAttribute : Attribute</code></div><div class="line number6 index5 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">[Obsolete(</code><code class="csharp string">"Use AddCleanupAction method instead of using [TestCleanup]"</code><code class="csharp plain">, </code><code class="csharp keyword">true</code><code class="csharp plain">)]</code></div><div class="line number10 index9 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">class</code> <code class="csharp plain">TestCleanupAttribute : Attribute</code></div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number12 index11 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">private</code> <code class="csharp keyword">readonly</code> <code class="csharp plain">List&lt;Action&gt; _cleanupActions = </code><code class="csharp keyword">new</code> <code class="csharp plain">List&lt;Action&gt;();</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">[Microsoft.VisualStudio.TestTools.UnitTesting.TestInitiailizeAttribute]</code></div><div class="line number17 index16 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">TestInitialize()</code></div><div class="line number18 index17 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number19 index18 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Console.WriteLine(</code><code class="csharp string">"=============================== Test initialize ==============================="</code><code class="csharp plain">);</code></div><div class="line number20 index19 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_cleanupActions.Clear();</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">try</code></div><div class="line number23 index22 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number24 index23 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Initialize();</code></div><div class="line number25 index24 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number26 index25 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">catch</code> <code class="csharp plain">(Exception)</code></div><div class="line number27 index26 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number28 index27 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">CallCleanupActions();</code></div><div class="line number29 index28 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">throw</code><code class="csharp plain">;</code></div><div class="line number30 index29 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Console.WriteLine(</code><code class="csharp string">"=============================== Test method ==============================="</code><code class="csharp plain">);</code></div><div class="line number33 index32 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Console.WriteLine();</code></div><div class="line number34 index33 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">protected</code> <code class="csharp keyword">virtual</code> <code class="csharp plain">Initialize() { }</code></div><div class="line number37 index36 alt2">&nbsp;</div><div class="line number38 index37 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">[Microsoft.VisualStudio.TestTools.UnitTesting.TestCleanupAttribute]</code></div><div class="line number39 index38 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">TestCleanup()</code></div><div class="line number40 index39 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number41 index40 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Console.WriteLine(</code><code class="csharp string">"=============================== Test Cleanup ==============================="</code><code class="csharp plain">);</code></div><div class="line number42 index41 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Console.WriteLine();</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">CallCleanupActions();</code></div><div class="line number45 index44 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number46 index45 alt1">&nbsp;</div><div class="line number47 index46 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">private</code> <code class="csharp keyword">void</code> <code class="csharp plain">CallCleanupActions()</code></div><div class="line number48 index47 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number49 index48 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_cleanupActions.Reverse();</code></div><div class="line number50 index49 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">exceptions = </code><code class="csharp keyword">new</code> <code class="csharp plain">List&lt;Exception&gt;();</code></div><div class="line number51 index50 alt2">&nbsp;</div><div class="line number52 index51 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code><code class="csharp plain">(</code><code class="csharp keyword">var</code> <code class="csharp plain">action </code><code class="csharp keyword">in</code> <code class="csharp plain">_cleanupActions)</code></div><div class="line number53 index52 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number54 index53 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">try</code></div><div class="line number55 index54 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number56 index55 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">action();</code></div><div class="line number57 index56 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number58 index57 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">catch</code><code class="csharp plain">(Exception ex)</code></div><div class="line number59 index58 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number60 index59 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_exceptions.Add(ex);</code></div><div class="line number61 index60 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Console.WriteLine(</code><code class="csharp string">"Cleanup action failed: "</code> <code class="csharp plain">+ ex);</code></div><div class="line number62 index61 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number63 index62 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number64 index63 alt1">&nbsp;</div><div class="line number65 index64 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">if</code> <code class="csharp plain">(exceptions.Count == 0)</code></div><div class="line number66 index65 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">return</code><code class="csharp plain">;</code></div><div class="line number67 index66 alt2">&nbsp;</div><div class="line number68 index67 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">if</code> <code class="csharp plain">(exceptions.Count == 1)</code></div><div class="line number69 index68 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">throw</code> <code class="csharp plain">exceptions.Single();</code></div><div class="line number70 index69 alt1">&nbsp;</div><div class="line number71 index70 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">throw</code> <code class="csharp keyword">new</code> <code class="csharp plain">AggregateException(</code><code class="csharp string">"Multiple exceptions occured in Cleanup. See test log for more details"</code><code class="csharp plain">, exceptions);</code></div><div class="line number72 index71 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number73 index72 alt2">&nbsp;</div><div class="line number74 index73 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">AddCleanupAction(Action cleanupAction)</code></div><div class="line number75 index74 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number76 index75 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">_cleanupActions.Add(cleanupAction);</code></div><div class="line number77 index76 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number78 index77 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<h3>Class and Assembly level Initialize and Cleanup</h3>
<p>In cases where global configuration or data should be changed for a group of tests (either from the same tests class or the same test assembly), the [ClassInitialize] and [AssemblyInitialize] attributes can be used. However, MSTest require that these methods be static, and if they’re defined in a base class, they don’t affect the derived class.</p>
<p>A possible solution could be to extract the above logic into a special class, (which can be called <b>ExecutionScope</b>). In the relevant [ClassInitialize] method, a new instance of this class can be created and kept in a private static variable. However, it’s still the responsibility of the user to call Cleanup() in the [ClassCleanup] method. A similar solution can be applied with [AssemblyInitialize] and [AssemblyCleanup].</p>
			<iframe src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/like.html" scrolling="no" frameborder="0" style="border:none; overflow:hidden; height:80px;" allowtransparency="true"></iframe>

							  <div class="clearfix entry-options">
                        <a href="javascript:void(0)" class="bp-add-comment">Add comment</a>
                        <div class="bp-social_i">
                           <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/" class="ir icon-fb">facebook</a>
                            <a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/&amp;title=The%20Right%20Way%20to%20do%20Test%20Cleanup&amp;summary=%3Cp%3EMSTest%20and%20NUnit,%20as%20most%20of%20the%20other%20common%20test%20frameworks,%20provide%20means%20for%20write%20cleanup%20code%20that%20is%20executed%20whether%20the%20test%20passed%20or%20failed.%20In%20addition%20they%20provide%20means%20to%20write%20cleanup%20code%20that%20runs%20after%20all%20tests%20in%20a%20class%20or%20assembly%20has%20completed.%20This%20is%20especially%20important%20in%20End-to-end%20or%20Integration%20[%E2%80%A6]%3C/p%3E" class="ir icon-in">linkedin</a>
                            <a target="_blank" href="https://twitter.com/share" class="tweet ir icon-twitter" data-lang="he">twitter</a>
                            <a href="mailto:?subject=The%20Right%20Way%20to%20do%20Test%20Cleanup&amp;body=Check%20out%20this%20post%20http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/" class="ir icon-email">email</a>
                            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                        </div>
                    </div>

				
		</div><!-- .entry-content -->
		

        
<div id="comments" class="comments-area">
	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/#respond" style="display:none;">Cancel Reply</a></small></h3>			<form action="http://blogs.microsoft.co.il/arnona/wp-comments-post.php" method="post" id="commentform" class="comment-form">
				<p class="comment-notes">Your email address will not be published.</p><p class="comment-form-comment"><label for="comment">Comment</label><textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p><p class="form-allowed-tags">You may use these <abbr title="HyperText Markup Language">HTML</abbr> tags and attributes:  <code>&lt;a href="" title=""&gt; &lt;abbr title=""&gt; &lt;acronym title=""&gt; &lt;b&gt; &lt;blockquote cite=""&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=""&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=""&gt; &lt;s&gt; &lt;strike&gt; &lt;strong&gt; </code></p><p class="comment-form-author"><label for="author">Name</label> <span class="required">*</span><input id="author" name="author" type="text" value="" size="30"></p>
<p class="comment-form-email"><label for="email">Email</label> <span class="required">*</span><input id="email" name="email" type="text" value="" size="30"></p>
<p class="comment-form-url"><label for="url">Website</label><input id="url" name="url" type="text" value="" size="30"></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment"> <input type="hidden" name="comment_post_ID" value="2085734" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="1aa49f5391"></p><script type="text/javascript">var RecaptchaOptions = {theme : "blackglass"};</script><script type="text/javascript" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/challenge"></script>

	<noscript>
  		<iframe src="http://www.google.com/recaptcha/api/noscript?k=6Ld4OuwSAAAAAC2pOGX1-HLYusMoy9UuR5_I91Eo" height="300" width="500" frameborder="0"></iframe><br/>
  		<textarea name="recaptcha_challenge_field" rows="3" cols="40"></textarea>
  		<input type="hidden" name="recaptcha_response_field" value="manual_challenge"/>
	</noscript><!-- AVH First Defense Against Spam - WPMU DEV Version version 2.3.2  --><input type="hidden" id="_avh_first_defense_against_spam" name="_avh_first_defense_against_spam" value="8411cddd9e"><p style="display: none;"></p>			<input type="hidden" id="ak_js" name="ak_js" value="1574167412003"></form>
			</div><!-- #respond -->
	<div class="clearfix"></div>
	
			
			 <h1 class="comments-title">2 comments</h1>

		<ol class="commentlist">
			    <li class="comment even thread-even depth-1" id="li-comment-2829203">
       <div class="clearfix">
        <div class="comment-avatar">
            <img src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/57b1c7b996be6e89a112ecf3ca3b0fc7.jpeg" width="50" height="50" alt="" class="avatar avatar-50wp-user-avatar wp-user-avatar-50 alignnone photo avatar-default">        </div>
        <div class="comment-post-body">
            <span class="comment-author">Carl Walsh</span><a class="comment-date" href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/#comment-2829203" data-datetime="2016-08-05T01:11:18+00:00">August 5, 2016 ב 1:11</a>
                
			    <div class="comment-content comment">
				    <p>Great read, interesting ideas!</p>
<p>One critique: calling <code>throw exceptions.Single();</code> causes the exception’s original call stack to be overwritten, which means you will have a harder time tracking down the bug in cleanup.</p>
<p>If you’re using the latest .NET you can use ExceptionDispatchInfo to save the call stack and rethrow the exception without losing the call stack.</p>
<p>If you’re stuck on an older .NET, you have to compromise. You get the same exception type by rethrowing it, but you need to log the stack trace before it’s overwritten. You could always wrap in AggregateException, which preserves the stack but you lose the type. Or you could re-implement ExceptionDispatchInfo by using reflection to poke some Exception internal fields.</p>
				                        <a rel="nofollow" class="comment-reply-link" href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/?replytocom=2829203#respond" onclick="return addComment.moveForm( &quot;comment-2829203&quot;, &quot;2829203&quot;, &quot;respond&quot;, &quot;2085734&quot; )" aria-label="Reply to Carl Walsh">Reply</a>			    </div><!-- .comment-content -->
        </div>
 
       </div>


	<ol class="children">
    <li class="comment byuser comment-author-arnona bypostauthor odd alt depth-2" id="li-comment-2829204">
       <div class="clearfix">
        <div class="comment-avatar">
            <img src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/d3548b43b3f07144c336ab8378da3ecd(1).jpeg" width="50" height="50" alt="" class="avatar avatar-50wp-user-avatar wp-user-avatar-50 alignnone photo avatar-default">        </div>
        <div class="comment-post-body">
            <span class="comment-author">Arnon Axelrod</span><a class="comment-date" href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/#comment-2829204" data-datetime="2016-08-16T16:55:21+00:00">August 16, 2016 ב 16:55</a>
                
			    <div class="comment-content comment">
				    <p>You’re totally right! When I wrote this post I still wasn’t aware of ExceptionDispatchInfo.</p>
				                        <a rel="nofollow" class="comment-reply-link" href="http://blogs.microsoft.co.il/arnona/2014/09/02/right-way-test-cleanup/?replytocom=2829204#respond" onclick="return addComment.moveForm( &quot;comment-2829204&quot;, &quot;2829204&quot;, &quot;respond&quot;, &quot;2085734&quot; )" aria-label="Reply to Arnon Axelrod">Reply</a>			    </div><!-- .comment-content -->
        </div>
 
       </div>


	</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		</ol><!-- .commentlist -->

		
		
	
	

</div><!-- #comments .comments-area -->
	<!--<div class="fb-comments" data-href="http://guideme.co.il/comments" data-colorscheme="The color scheme used in the plugin" data-numposts="5" data-width="The pixel width of the plugin"></div>-->

				
	
	</article><!-- #post -->
				
				
						
	

</section>
		
			<div id="secondary" class="widget-area" role="complementary">
			<aside id="search-2" class="widget widget_search"><form role="search" method="get" id="searchform" class="searchform" action="http://blogs.microsoft.co.il/arnona/">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s">
					<input type="submit" id="searchsubmit" value="Search">
				</div>
			</form></aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h3 class="widget-title">Recent Posts</h3>		<ul>
											<li>
					<a href="http://blogs.microsoft.co.il/arnona/2018/09/27/continuing-my-blog-on-medium-com/">Continuing my blog on Medium.com</a>
									</li>
											<li>
					<a href="http://blogs.microsoft.co.il/arnona/2018/09/26/best-practices-for-choosing-locators-for-selenium/">Best Practices for Choosing Locators for Selenium</a>
									</li>
											<li>
					<a href="http://blogs.microsoft.co.il/arnona/2018/07/10/my-book-complete-guide-to-test-automation-is-due-in-september/">My book "Complete Guide to Test Automation" is due in September</a>
									</li>
											<li>
					<a href="http://blogs.microsoft.co.il/arnona/2017/03/06/selenium-in-depth-the-demos/">Selenium in Depth – the demos</a>
									</li>
											<li>
					<a href="http://blogs.microsoft.co.il/arnona/2016/11/09/writing-maintainable-automated-test-and-infrastructure-with-live-video-recording/">Writing maintainable automated test and infrastructure – With live video recording!</a>
									</li>
					</ul>
		</aside><aside id="recent-comments-2" class="widget widget_recent_comments"><h3 class="widget-title">Recent Comments</h3><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link">Nishant Shah</span> on <a href="http://blogs.microsoft.co.il/arnona/2016/01/03/keeping-an-active-desktop-session/#comment-2829242">Keeping an active desktop session</a></li><li class="recentcomments"><span class="comment-author-link">Nishant Shah</span> on <a href="http://blogs.microsoft.co.il/arnona/2016/01/03/keeping-an-active-desktop-session/#comment-2829241">Keeping an active desktop session</a></li><li class="recentcomments"><span class="comment-author-link">Milan Zeleznik</span> on <a href="http://blogs.microsoft.co.il/arnona/2016/01/03/keeping-an-active-desktop-session/#comment-2829240">Keeping an active desktop session</a></li><li class="recentcomments"><span class="comment-author-link">warren</span> on <a href="http://blogs.microsoft.co.il/arnona/2016/01/03/keeping-an-active-desktop-session/#comment-2829239">Keeping an active desktop session</a></li><li class="recentcomments"><span class="comment-author-link">Arnon Axelrod</span> on <a href="http://blogs.microsoft.co.il/arnona/2016/01/03/keeping-an-active-desktop-session/#comment-2829237">Keeping an active desktop session</a></li></ul></aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
			<li><a href="http://blogs.microsoft.co.il/arnona/2018/09/">September 2018</a></li>
	<li><a href="http://blogs.microsoft.co.il/arnona/2018/07/">July 2018</a></li>
	<li><a href="http://blogs.microsoft.co.il/arnona/2017/03/">March 2017</a></li>
	<li><a href="http://blogs.microsoft.co.il/arnona/2016/11/">November 2016</a></li>
	<li><a href="http://blogs.microsoft.co.il/arnona/2016/07/">July 2016</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2016/04/">April 2016</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2016/03/">March 2016</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2016/01/">January 2016</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2015/10/">October 2015</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2015/08/">August 2015</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2015/04/">April 2015</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2015/01/">January 2015</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2014/09/">September 2014</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2013/12/">December 2013</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2013/05/">May 2013</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2013/02/">February 2013</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2012/12/">December 2012</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2012/09/">September 2012</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2012/07/">July 2012</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2012/05/">May 2012</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2012/04/">April 2012</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2012/03/">March 2012</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2012/02/">February 2012</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/12/">December 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/11/">November 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/10/">October 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/09/">September 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/08/">August 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/07/">July 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/06/">June 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/03/">March 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/02/">February 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2011/01/">January 2011</a></li>
	<li style="display: none;"><a href="http://blogs.microsoft.co.il/arnona/2010/12/">December 2010</a></li>
		<li><a class="a-txt" href="javascript:void(0)">Full Arcive</a></li></ul>
		</aside><aside id="categories-2" class="widget widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
	<li class="cat-item cat-item-21027"><a href="http://blogs.microsoft.co.il/arnona/category/continuous-improvement/">Continuous Improvement</a>
</li>
	<li class="cat-item cat-item-21026"><a href="http://blogs.microsoft.co.il/arnona/category/test-automation/">Test Automation</a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta"><h3 class="widget-title">Meta</h3>			<ul>
			<li><a href="https://blogs.microsoft.co.il/arnona/wp-login.php?action=register">Register</a></li>			<li><a href="https://blogs.microsoft.co.il/arnona/wp-login.php">Log in</a></li>
			<li><a href="http://blogs.microsoft.co.il/arnona/feed/">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://blogs.microsoft.co.il/arnona/comments/feed/">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
			</aside>			<aside class="widget mrg">
		
			<div class="moposts">
			<h3 class="widget-title"> Additional Posts </h3>
								  <a href="http://blogs.microsoft.co.il/arnona/2018/09/27/continuing-my-blog-on-medium-com/" class="latest_art">
					<div class="la-date">September 27, 2018</div>
					<h4>Continuing my blog on Medium.com</h4>
		
                    <p>An era has come to an end. It’s time to move on to a new and modern blogging website. My next blog posts will be published on&nbsp;https://medium.com/@arnonaxelrod Happy reading!</p>
			      </a>
								  <a href="http://blogs.microsoft.co.il/arnona/2018/09/26/best-practices-for-choosing-locators-for-selenium/" class="latest_art">
					<div class="la-date">September 26, 2018</div>
					<h4>Best Practices for Choosing Locators for Selenium</h4>
		
                    <p>A question that comes often, especially by folks that are new to Selenium, is what are the best practices to use when choosing a locator for an element. In other cases, people just have bad habits and don’t even think to ask this question, but they encounter instabilities or maintenance problems, without knowing that they […]</p>
			      </a>
								  <a href="http://blogs.microsoft.co.il/arnona/2018/07/10/my-book-complete-guide-to-test-automation-is-due-in-september/" class="latest_art">
					<div class="la-date">July 10, 2018</div>
					<h4>My book "Complete Guide to Test Automation" is due in September</h4>
		
                    <p>Update: The book is available at Amazon, or directly through Apress. According to the last time I’ve checked, Amazon had a better price a hard copy, but had no option for a soft copy, while through Apress you can order either a hard copy or a soft copy. I’m very proud to let you know […]</p>
			      </a>
								</div>
				
				</aside>
		</div><!-- #secondary -->
	</div>
	</div>

	<footer class="footer_main clearfix">
	<section class="wrapper clearfix">
		<article id="first_fl" class="footer_list">
		<h3>משאבים לקהילת המפתחים</h3>
			<div class="menu-footer1-container">
				<ul id="menu-footer-menu-2">
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://blogs.microsoft.co.il/msdn" title="MSDN בלוג" target="_blank">בלוג MSDN</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoft.com/israel/msdn/pulse/" title="ניוזלטר  MSDN" target="_blank">ניוזלטר  MSDN</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.facebook.com/msdnisrael" title="MSDN בפייסבוק" target="_blank">בפייסבוק MSDN</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.youtube.com/channel/UCp6wuFkya3jOETs_nM7z3Fw?feature=watch" target="_blank">יוטיוב  MSDN</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoftvirtualacademy.com/" target="_blank">האקדמיה הוירטואלית</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://msdn.microsoft.com/en-us/evalcenter/default" target="_blank">התנסות חינם</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoft.com/israel/4steps/" target="_blank">אתר פיתוח אפליקציות</a></li>
				</ul>
			</div>
		</article>
			<article id="sec_fl" class="footer_list">
		<h3>משאבים לקהילת IT</h3>
				<ul id="menu-footer-menu-2">
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://blogs.microsoft.co.il/technet" title="TechNet בלוג" target="_blank">בלוג TechNet </a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoft.com/israel/technetflash/Prev_vers/index.htm" target="_blank">ניוזלטר  TechNet </a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.facebook.com/technetil" title="TechNet בפייסבוק" target="_blank">בפייסבוק TechNet</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.youtube.com/user/TechNetIsrael/videos" target="_blank">יוטיוב  TechNet</a></li>
								<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoftvirtualacademy.com/" target="_blank">האקדמיה הוירטואלית</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://technet.microsoft.com/en-us/evalcenter/default" target="_blank">התנסות חינם</a></li>
				</ul>
			</article>
			<article id="thrd_fl" class="footer_list">
		<h3>משאבים כללים </h3>
					<ul id="menu-footer-menu-2">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoft.com/he-il/default.aspx" target="_blank" title="אתר מיקרוסופט ישראל">אתר מיקרוסופט ישראל</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.facebook.com/microsoftisrael" target="_blank" title="מיקרוסופט ישראל בפייסבוק">מיקרוסופט ישראל בפייסבוק</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://social.msdn.microsoft.com/Forums/he-il/categories" target="_blank" title="&gt;אתר הפורומים">אתר הפורומים</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoft.com/israel/communities/usergroups/default.aspx" target="_blank" title="&gt;קבוצות משתמשים">קבוצות משתמשים</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://www.microsoft.com/israel/traincert/" target="_blank" title="הדרכות והסמכות מיקרוסופט">הדרכות והסמכות מיקרוסופט</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://msevents.microsoft.com/CUI/default.aspx?culture=he-IL" target="_blank">אירועים </a></li>
					
					<!--
					<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://blogs.microsoft.co.il/סימנים-מסחריים/" title=" סימנים מסחריים"> סימנים מסחריים</a></li>
				<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://blogs.microsoft.co.il/תנאי-שימוש/" title="תנאי שימוש">תנאי שימוש</a></li>
-->
				</ul>	</article>
		</section>
		<section class="sfooter">
                <div class="content">
                    <div class="footer-bottom">                        
                        <ul class="legal">
                            <li><a href="http://choice.microsoft.com/">אודות הפרסומות שלנו</a></li>
                            <li><a href="http://www.microsoft.com/About/Legal/EN/US/IntellectualProperty/Trademarks/EN-US.aspx">סימנים מסחריים</a></li>
                            <li><a href="http://www.microsoft.com/en-us/legal/intellectualproperty/copyright/default.aspx">תנאי השימוש</a></li>
                            <li><a href="http://go.microsoft.com/fwlink/?LinkId=248681">הצהרת פרטיות</a></li>
                        </ul>
                        <div class="footer-copyright">
                            <a href="http://www.microsoft.com/">
                                <img alt="Microsoft" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/microsoft-logo-heb.png">
                            </a><span>© 2014 Microsoft</span>
                        </div>
                    </div>
                </div>
</section>
	</footer><!-- #colophon -->
    <script>
        (function (window) {
            var rSide = document.getElementById("blog_post_info");
            var lSide = document.getElementById("secondary");
			
			setTimeout(function(){
				rSide = document.getElementById("blog_post_info");
				lSide = document.getElementById("secondary");
				if (lSide.offsetHeight > rSide.offsetHeight) {
					rSide.style.minHeight = lSide.offsetHeight + "px";
				}
			},1000);

            window.onresize = function () {
                if (lSide.offsetHeight > rSide.offsetHeight) {
                    rSide.style.minHeight = lSide.offsetHeight + "px";
                }
            }
        })(window);


    </script>
	
<!-- Do Not Remove - Turn Tracking Beacon Code - Do Not Remove -->
<!-- Advertiser Name : microsoft -->
<!-- Beacon Name : Microsoft_ blogs general -->
<!-- START OF WEDCS TAG -->
<script type="text/javascript">
    var varSegmentation = 0;
    var varClickTracking = 1;
    var varCustomerTracking = 1;
    var varAutoFirePV = 1;
    var Route = "LE020";
    document.write("<script type='text/javascript' src='" +
    (window.location.protocol) + "//c.microsoft.com/ms.js'" + "'><\/script>");
</script><script type="text/javascript" src="http://c.microsoft.com/ms.js" '=""></script>
<noscript>
    <img alt="" width="1" height="1" src="http://c.microsoft.com/trans_pixel.aspx" />
</noscript>
<!-- END OF WEDCS TAG -->





<!-- If Beacon is placed on a Transaction or Lead Generation based page, please populate the turn_client_track_id with your order/confirmation ID -->
<script type="text/javascript">
  turn_client_track_id = "";
</script>
<script type="text/javascript" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/beacon_call.js.download">
</script><img height="1" width="1" border="0" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/beacon">
<noscript>
  <img border="0" src="http://r.turn.com/r/beacon?b2=PGyOFcFmMNXjqLZWhsqf0IYBbGja1CD2b3Qxz0EXcZ4jZElP3T1utc_BawhZaoxwRafeYDFgKVEXkxLRf3dk_A&cid=">
</noscript>
<!-- End Turn Tracking Beacon Code Do Not Remove -->

<script>
(function() { // Redistats, track version 1.0
	var global_id = 147;
	var property_id = 1346;
	var url = encodeURIComponent(window.location.href.split('#')[0]);
	var referrer = encodeURIComponent(document.referrer);
	var x = document.createElement('script'), s = document.getElementsByTagName('script')[0];
	x.src = '//redistats.com/track.js?gid='+global_id+'&pid='+property_id+'&url='+url+'&referrer='+referrer;
	s.parentNode.insertBefore(x, s);
})();
</script><script type="text/javascript" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/shCore.js.download"></script>
<script type="text/javascript" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/shBrushCSharp.js.download"></script>
<script type="text/javascript">
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://blogs.microsoft.co.il/arnona/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://blogs.microsoft.co.il/arnona/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type="text/javascript" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/comment-reply.min.js.download"></script>
<script type="text/javascript" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/wp-embed.min.js.download"></script>
<script async="async" type="text/javascript" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/form.js.download"></script>

<iframe scrolling="no" frameborder="0" allowtransparency="true" src="./The Right Way to do Test Cleanup _ Arnon Axelrod&#39;s Blog_files/widget_iframe.d942dbac55d395b6a752976f272a24f6.html" title="Twitter settings iframe" style="display: none;"></iframe></body></html>